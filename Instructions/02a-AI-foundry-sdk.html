<h1 id="create-a-generative-ai-chat-app">Create a generative AI chat app</h1>

<p>In this exercise, you use the Azure AI Foundry Python SDK to create a simple chat app that connects to a project and chats with a language model.</p>

<blockquote>
  <p><strong>Note</strong>: This exercise is based on pre-release SDK software, which may be subject to change. Where necessary, we’ve used specific versions of packages; which may not reflect the latest available versions. You may experience some unexpected behavior, warnings, or errors.</p>
</blockquote>

<p>While this exercise is based on the Azure AI Foundry Python SDK, you can develop AI chat applications using multiple language-specific SDKs; including:</p>

<ul>
  <li><a href="https://pypi.org/project/azure-ai-projects">Azure AI Projects for Python</a></li>
  <li><a href="https://www.nuget.org/packages/Azure.AI.Projects">Azure AI Projects for Microsoft .NET</a></li>
  <li><a href="https://www.npmjs.com/package/@azure/ai-projects">Azure AI Projects for JavaScript</a></li>
</ul>

<p>This exercise takes approximately <strong>40</strong> minutes.</p>

<h2 id="deploy-a-model-in-an-azure-ai-foundry-project">Deploy a model in an Azure AI Foundry project</h2>

<p>Let’s start by deploying a model in an Azure AI Foundry project.</p>

<ol>
  <li>
    <p>In a web browser, open the <a href="https://ai.azure.com">Azure AI Foundry portal</a> at <code>https://ai.azure.com</code> and sign in using your Azure credentials. Close any tips or quick start panes that are opened the first time you sign in, and if necessary use the <strong>Azure AI Foundry</strong> logo at the top left to navigate to the home page, which looks similar to the following image (close the <strong>Help</strong> pane if it’s open):</p>

    <p><img src="./media/ai-foundry-home.png" alt="Screenshot of Azure AI Foundry portal." /></p>
  </li>
  <li>In the home page, in the <strong>Explore models and capabilities</strong> section, search for the <code>gpt-4o</code> model; which we’ll use in our project.</li>
  <li>In the search results, select the <strong>gpt-4o</strong> model to see its details, and then at the top of the page for the model, select <strong>Use this model</strong>.</li>
  <li>When prompted to create a project, enter a valid name for your project and expand <strong>Advanced options</strong>.</li>
  <li>Select <strong>Customize</strong> and specify the following settings for your project:
    <ul>
      <li><strong>Azure AI Foundry resource</strong>: <em>A valid name for your Azure AI Foundry resource</em></li>
      <li><strong>Subscription</strong>: <em>Your Azure subscription</em></li>
      <li><strong>Resource group</strong>: <em>Create or select a resource group</em></li>
      <li><strong>Region</strong>: <em>Select any <strong>AI Foundry recommended</strong></em>*</li>
    </ul>

    <blockquote>
      <p>* Some Azure AI resources are constrained by regional model quotas. In the event of a quota limit being exceeded later in the exercise, there’s a possibility you may need to create another resource in a different region.</p>
    </blockquote>
  </li>
  <li>
    <p>Select <strong>Create</strong> and wait for your project to be created. If prompted, deploy the gpt-4o model using the <strong>Global standard</strong> deployment type and customize the deployment details to set a <strong>Tokens per minute rate limit</strong> of 50K (or the maximum available if less than 50K).</p>

    <blockquote>
      <p><strong>Note</strong>: Reducing the TPM helps avoid over-using the quota available in the subscription you are using. 50,000 TPM should be sufficient for the data used in this exercise. If your available quota is lower than this, you will be able to complete the exercise but you may experience errors if the rate limit is exceeded.</p>
    </blockquote>
  </li>
  <li>When your project is created, the chat playground will be opened automatically so you can test your model:</li>
  <li>In the <strong>Setup</strong> pane, note the name of your model deployment; which should be <strong>gpt-4o</strong>. You can confirm this by viewing the deployment in the <strong>Models and endpoints</strong> page (just open that page in the navigation pane on the left).</li>
  <li>
    <p>In the navigation pane on the left, select <strong>Overview</strong> to see the main page for your project; which looks like this:</p>

    <p><img src="./media/ai-foundry-project.png" alt="Screenshot of a Azure AI Foundry project overview page." /></p>
  </li>
</ol>

<h2 id="create-a-client-application-to-chat-with-the-model">Create a client application to chat with the model</h2>

<p>Now that you have deployed a model, you can use the Azure AI Foundry and Azure OpenAI SDKs to develop an application that chats with it.</p>

<h3 id="prepare-the-application-configuration">Prepare the application configuration</h3>

<ol>
  <li>In the Azure AI Foundry portal, view the <strong>Overview</strong> page for your project.</li>
  <li>
    <p>In the <strong>Endpoints and keys</strong> area, ensure that the <strong>Azure AI Foundry</strong> library is selected and view the <strong>Azure AI Foundry project endpoint</strong>. You’ll use this endpoint to connect to your project and model in a client application.</p>

    <blockquote>
      <p><strong>Note</strong>: You can also use the Azure OpenAI endpoint!</p>
    </blockquote>
  </li>
  <li>
    <p>Open a new browser tab (keeping the Azure AI Foundry portal open in the existing tab). Then in the new tab, browse to the <a href="https://portal.azure.com">Azure portal</a> at <code>https://portal.azure.com</code>; signing in with your Azure credentials if prompted.</p>

    <p>Close any welcome notifications to see the Azure portal home page.</p>
  </li>
  <li>
    <p>Use the <strong>[&gt;_]</strong> button to the right of the search bar at the top of the page to create a new Cloud Shell in the Azure portal, selecting a <strong><em>PowerShell</em></strong> environment with no storage in your subscription.</p>

    <p>The cloud shell provides a command-line interface in a pane at the bottom of the Azure portal. You can resize or maximize this pane to make it easier to work in.</p>

    <blockquote>
      <p><strong>Note</strong>: If you have previously created a cloud shell that uses a <em>Bash</em> environment, switch it to <strong><em>PowerShell</em></strong>.</p>
    </blockquote>
  </li>
  <li>
    <p>In the cloud shell toolbar, in the <strong>Settings</strong> menu, select <strong>Go to Classic version</strong> (this is required to use the code editor).</p>

    <p><strong><font color="red">Ensure you've switched to the classic version of the cloud shell before continuing.</font></strong></p>
  </li>
  <li>
    <p>In the cloud shell pane, enter the following commands to clone the GitHub repo containing the code files for this exercise (type the command, or copy it to the clipboard and then right-click in the command line and paste as plain text):</p>

    <pre><code>rm -r mslearn-ai-foundry -f
git clone https://github.com/microsoftlearning/mslearn-ai-studio mslearn-ai-foundry
</code></pre>

    <blockquote>
      <p><strong>Tip</strong>: As you enter commands into the cloudshell, the output may take up a large amount of the screen buffer. You can clear the screen by entering the <code>cls</code> command to make it easier to focus on each task.</p>
    </blockquote>
  </li>
  <li>
    <p>After the repo has been cloned, navigate to the folder containing the chat application code files and view them:</p>

    <pre><code>cd mslearn-ai-foundry/labfiles/chat-app/python
ls -a -l
</code></pre>

    <p>The folder contains a code file as well as a configuration file for application settings and a file defining the project runtime and package requrirements.</p>
  </li>
  <li>
    <p>In the cloud shell command-line pane, enter the following command to install the libraries you’ll use:</p>

    <pre><code>python -m venv labenv
./labenv/bin/Activate.ps1
pip install -r requirements.txt azure-identity azure-ai-projects openai
</code></pre>
  </li>
  <li>
    <p>Enter the following command to edit the configuration file that has been provided:</p>

    <pre><code>code .env
</code></pre>

    <p>The file is opened in a code editor.</p>
  </li>
  <li>In the code file, replace the <strong>your_project_endpoint</strong> placeholder with the <strong>Azure AI Foundry project endpoint</strong> for your project (copied from the <strong>Overview</strong> page in the Azure AI Foundry portal); and the <strong>your_model_deployment</strong> placeholder with the name of your gpt-4 model deployment.</li>
  <li>After you’ve replaced the placeholders, within the code editor, use the <strong>CTRL+S</strong> command or <strong>Right-click &gt; Save</strong> to save your changes and then use the <strong>CTRL+Q</strong> command or <strong>Right-click &gt; Quit</strong> to close the code editor while keeping the cloud shell command line open.</li>
</ol>

<h3 id="write-code-to-connect-to-your-project-and-chat-with-your-model">Write code to connect to your project and chat with your model</h3>

<blockquote>
  <p><strong>Tip</strong>: As you add code, be sure to maintain the correct indentation.</p>
</blockquote>

<ol>
  <li>
    <p>Enter the following command to edit the code file that has been provided:</p>

    <pre><code>code chat-app.py
</code></pre>
  </li>
  <li>
    <p>In the code file, note the existing statements that have been added at the top of the file to import the necessary SDK namespaces. Then, find the comment <strong>Add references</strong>, and add the following code to reference the namespaces in the libraries you installed previously:</p>

    <pre><code class="language-python"># Add references
from azure.identity import DefaultAzureCredential
from azure.ai.projects import AIProjectClient
from openai import AzureOpenAI
</code></pre>
  </li>
  <li>In the <strong>main</strong> function, under the comment <strong>Get configuration settings</strong>, note that the code loads the project connection string and model deployment name values you defined in the configuration file.</li>
  <li>
    <p>Find the comment <strong>Initialize the project client</strong>, and add the following code to connect to your Azure AI Foundry project:</p>

    <blockquote>
      <p><strong>Tip</strong>: Be careful to maintain the correct indentation level for your code.</p>
    </blockquote>

    <pre><code class="language-python"># Initialize the project client
project_client = AIProjectClient(            
         credential=DefaultAzureCredential(
             exclude_environment_credential=True,
             exclude_managed_identity_credential=True
         ),
         endpoint=project_endpoint,
     )
</code></pre>
  </li>
  <li>
    <p>Find the comment <strong>Get a chat client</strong>, and add the following code to create a client object for chatting with a model:</p>

    <pre><code class="language-python"># Get a chat client
openai_client = project_client.get_openai_client(api_version="2024-10-21")
</code></pre>
  </li>
  <li>
    <p>Find the comment <strong>Initialize prompt with system message</strong>, and add the following code to initialize a collection of messages with a system prompt.</p>

    <pre><code class="language-python"># Initialize prompt with system message
prompt = [
         {"role": "system", "content": "You are a helpful AI assistant that answers questions."}
     ]
</code></pre>
  </li>
  <li>
    <p>Note that the code includes a loop to allow a user to input a prompt until they enter “quit”. Then in the loop section, find the comment <strong>Get a chat completion</strong> and add the following code to add the user input to the prompt, retrieve the completion from your model, and add the completion to the prompt (so that you retain chat history for future iterations):</p>

    <pre><code class="language-python"># Get a chat completion
prompt.append({"role": "user", "content": input_text})
response = openai_client.chat.completions.create(
         model=model_deployment,
         messages=prompt)
completion = response.choices[0].message.content
print(completion)
prompt.append({"role": "assistant", "content": completion})
</code></pre>
  </li>
  <li>Use the <strong>CTRL+S</strong> command to save your changes to the code file.</li>
</ol>

<h3 id="sign-into-azure-and-run-the-app">Sign into Azure and run the app</h3>

<ol>
  <li>
    <p>In the cloud shell command-line pane, enter the following command to sign into Azure.</p>

    <pre><code>az login
</code></pre>

    <p><strong><font color="red">You must sign into Azure - even though the cloud shell session is already authenticated.</font></strong></p>

    <blockquote>
      <p><strong>Note</strong>: In most scenarios, just using <em>az login</em> will be sufficient. However, if you have subscriptions in multiple tenants, you may need to specify the tenant by using the <em>–tenant</em> parameter. See <a href="https://learn.microsoft.com/cli/azure/authenticate-azure-cli-interactively">Sign into Azure interactively using the Azure CLI</a> for details.</p>
    </blockquote>
  </li>
  <li>When prompted, follow the instructions to open the sign-in page in a new tab and enter the authentication code provided and your Azure credentials. Then complete the sign in process in the command line, selecting the subscription containing your Azure AI Foundry hub if prompted.</li>
  <li>
    <p>After you have signed in, enter the following command to run the application:</p>

    <pre><code>python chat-app.py
</code></pre>
  </li>
  <li>When prompted, enter a question, such as <code>What is the fastest animal on Earth?</code> and review the response from your generative AI model.</li>
  <li>Try some follow-up questions, like <code>Where can I see one?</code> or <code>Are they endangered?</code>. The conversation should continue, using the chat history as context for each iteration.</li>
  <li>When you’re finished, enter <code>quit</code> to exit the program.</li>
</ol>

<blockquote>
  <p><strong>Tip</strong>: If the app fails because the rate limit is exceeded. Wait a few seconds and try again. If there is insufficient quota available in your subscription, the model may not be able to respond.</p>
</blockquote>

<h2 id="summary">Summary</h2>

<p>In this exercise, you used the Azure AI Foundry SDK to create a client application for a generative AI model that you deployed in an Azure AI Foundry project.</p>

<h2 id="clean-up">Clean up</h2>

<p>If you’ve finished exploring Azure AI Foundry portal, you should delete the resources you have created in this exercise to avoid incurring unnecessary Azure costs.</p>

<ol>
  <li>Open the <a href="https://portal.azure.com">Azure portal</a> and view the contents of the resource group where you deployed the resources used in this exercise.</li>
  <li>On the toolbar, select <strong>Delete resource group</strong>.</li>
  <li>Enter the resource group name and confirm that you want to delete it.</li>
</ol>
