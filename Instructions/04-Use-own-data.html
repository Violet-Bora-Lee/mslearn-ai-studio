<h1 id="create-a-generative-ai-app-that-uses-your-own-data">Create a generative AI app that uses your own data</h1>

<p>Retrieval Augmented Generation (RAG) is a technique used to build applications that integrate data from custom data sources into a prompt for a generative AI model. RAG is a commonly used pattern for developing generative AI apps - chat-based applications that use a language model to interpret inputs and generate appropriate responses.</p>

<p>In this exercise, you’ll use Azure AI Foundry to integrate custom data into a generative AI solution.</p>

<blockquote>
  <p><strong>Note</strong>: The code in this exercise is based on pre-release SDK software, which may be subject to change. Where necessary, we’ve used specific versions of packages; which may not reflect the latest available versions. You may experience some unexpected behavior, warnings, or errors.</p>
</blockquote>

<p>While this exercise is based on the Azure OpenAI Python SDK, you can develop AI chat applications using multiple language-specific SDKs; including:</p>

<ul>
  <li><a href="https://pypi.org/project/openai/">OpenAI for Python</a></li>
  <li><a href="https://www.nuget.org/packages/Azure.AI.OpenAI">Azure Open AI for Microsoft .NET</a></li>
  <li><a href="https://www.npmjs.com/package/@azure/openai">Azure OpenAI for TypeScript</a></li>
</ul>

<p>This exercise takes approximately <strong>45</strong> minutes.</p>

<h2 id="create-an-azure-ai-foundry-hub-and-project">Create an Azure AI Foundry hub and project</h2>

<p>The features of Azure AI Foundry we’re going to use in this exercise require a project that is based on an Azure AI Foundry <em>hub</em> resource.</p>

<ol>
  <li>
    <p>In a web browser, open the <a href="https://ai.azure.com">Azure AI Foundry portal</a> at <code>https://ai.azure.com</code> and sign in using your Azure credentials. Close any tips or quick start panes that are opened the first time you sign in, and if necessary use the <strong>Azure AI Foundry</strong> logo at the top left to navigate to the home page, which looks similar to the following image (close the <strong>Help</strong> pane if it’s open):</p>

    <p><img src="./media/ai-foundry-home.png" alt="Screenshot of Azure AI Foundry portal." /></p>
  </li>
  <li>In the browser, navigate to <code>https://ai.azure.com/managementCenter/allResources</code> and select <strong>Create new</strong>. Then choose the option to create a new <strong>AI hub resource</strong>.</li>
  <li>In the <strong>Create a project</strong> wizard, enter a valid name for your project, and select the option to create a new hub. Then use the <strong>Rename hub</strong> link to specify a valid name for your new hub, expand <strong>Advanced options</strong>, and specify the following settings for your project:
    <ul>
      <li><strong>Subscription</strong>: <em>Your Azure subscription</em></li>
      <li><strong>Resource group</strong>: <em>Create or select a resource group</em></li>
      <li><strong>Region</strong>:  East US 2 or Sweden Central (<em>In the event of a quota limit being exceeded later in the exercise, you may need to create another resource in a different region.</em>)</li>
    </ul>

    <blockquote>
      <p><strong>Note</strong>: If you’re working in an Azure subscription in which policies are used to restrict allowable resource names, you may need to use the link at the bottom of the <strong>Create a new project</strong> dialog box to create the hub using the Azure portal.</p>
    </blockquote>

    <blockquote>
      <p><strong>Tip</strong>: If the <strong>Create</strong> button is still disabled, be sure to rename your hub to a unique alphanumeric value.</p>
    </blockquote>
  </li>
  <li>Wait for your project to be created, and then navigate to your project.</li>
</ol>

<h2 id="deploy-models">Deploy models</h2>

<p>You need two models to implement your solution:</p>

<ul>
  <li>An <em>embedding</em> model to vectorize text data for efficient indexing and processing.</li>
  <li>A model that can generate natural language responses to questions based on your data.</li>
</ul>

<ol>
  <li>In the Azure AI Foundry portal, in your project, in the navigation pane on the left, under <strong>My assets</strong>, select the <strong>Models + endpoints</strong> page.</li>
  <li>
    <p>Create a new deployment of the <strong>text-embedding-ada-002</strong> model with the following settings by selecting <strong>Customize</strong> in the Deploy model wizard:</p>

    <ul>
      <li><strong>Deployment name</strong>: <em>A valid name for your model deployment</em></li>
      <li><strong>Deployment type</strong>: Global Standard</li>
      <li><strong>Model version</strong>: <em>Select the default version</em></li>
      <li><strong>Connected AI resource</strong>: <em>Select the resource created previously</em></li>
      <li><strong>Tokens per Minute Rate Limit (thousands)</strong>: 50K <em>(or the maximum available in your subscription if less than 50K)</em></li>
      <li><strong>Content filter</strong>: DefaultV2</li>
    </ul>

    <blockquote>
      <p><strong>Note</strong>: If your current AI resource location doesn’t have quota available for the model you want to deploy, you will be asked to choose a different location where a new AI resource will be created and connected to your project.</p>
    </blockquote>
  </li>
  <li>
    <p>Return to the <strong>Models + endpoints</strong> page and repeat the previous steps to deploy a <strong>gpt-4o</strong> model using a <strong>Global Standard</strong> deployment of the most recent version with a TPM rate limit of <strong>50K</strong> (or the maximum available in your subscription if less than 50K).</p>

    <blockquote>
      <p><strong>Note</strong>: Reducing the Tokens Per Minute (TPM) helps avoid over-using the quota available in the subscription you are using. 50,000 TPM is sufficient for the data used in this exercise.</p>
    </blockquote>
  </li>
</ol>

<h2 id="add-data-to-your-project">Add data to your project</h2>

<p>The data for your app consists of a set of travel brochures in PDF format from the fictitious travel agency <em>Margie’s Travel</em>. Let’s add them to the project.</p>

<ol>
  <li>In a new browser tab, download the <a href="https://github.com/MicrosoftLearning/mslearn-ai-studio/raw/main/data/brochures.zip">zipped archive of brochures</a> from <code>https://github.com/MicrosoftLearning/mslearn-ai-studio/raw/main/data/brochures.zip</code> and extract it to a folder named <strong>brochures</strong> on your local file system.</li>
  <li>In Azure AI Foundry portal, in your project, in the navigation pane on the left, under <strong>My assets</strong>, select the <strong>Data + indexes</strong> page.</li>
  <li>Select <strong>+ New data</strong>.</li>
  <li>In the <strong>Add your data</strong> wizard, expand the drop-down menu to select <strong>Upload files/folders</strong>.</li>
  <li>Select <strong>Upload folder</strong> and upload the <strong>brochures</strong> folder. Wait until all the files in the folder are listed.</li>
  <li>Select <strong>Next</strong> and set the data name to <code>brochures</code>.</li>
  <li>Wait for the folder to be uploaded and note that it contains several .pdf files.</li>
</ol>

<h2 id="create-an-index-for-your-data">Create an index for your data</h2>

<p>Now that you’ve added a data source to your project, you can use it to create an index in your Azure AI Search resource.</p>

<ol>
  <li>In Azure AI Foundry portal, in your project, in the navigation pane on the left, under <strong>My assets</strong>, select the <strong>Data + indexes</strong> page.</li>
  <li>In the <strong>Indexes</strong> tab, add a new index with the following settings:
    <ul>
      <li><strong>Source location</strong>:
        <ul>
          <li><strong>Data source</strong>: Data in Azure AI Foundry
            <ul>
              <li><em>Select the <strong>brochures</strong> data source</em></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><strong>Index configuration</strong>:
        <ul>
          <li><strong>Select Azure AI Search service</strong>: <em>Create a new Azure AI Search resource with the following settings</em>:
            <ul>
              <li><strong>Subscription</strong>: <em>You Azure subscription</em></li>
              <li><strong>Resource group</strong>: <em>The same resource group as your AI hub</em></li>
              <li><strong>Service name</strong>: <em>A valid name for your AI Search Resource</em></li>
              <li><strong>Location</strong>: <em>The same location as your AI hub</em></li>
              <li><strong>Pricing tier</strong>: Basic</li>
            </ul>

            <p>Wait for the AI Search resource to be created. Then return to the Azure AI Foundry and finish configuring the index by selecting <strong>Connect other Azure AI Search resource</strong> and adding a connection to the AI Search resource you just created.</p>
          </li>
          <li><strong>Vector index</strong>: <code>brochures-index</code></li>
          <li><strong>Virtual machine</strong>: Auto select</li>
        </ul>
      </li>
      <li><strong>Search settings</strong>:
        <ul>
          <li><strong>Vector settings</strong>: Add vector search to this search resource</li>
          <li><strong>Azure OpenAI connection</strong>: <em>Select the default Azure OpenAI resource for your hub.</em></li>
          <li><strong>Embedding model</strong>: text-embedding-ada-002</li>
          <li><strong>Embedding model deployment</strong>: <em>Your deployment of the</em> text-embedding-ada-002 <em>model</em></li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p>Create the vector index and wait for the indexing process to be completed, which can take a while depending on available compute resources in your subscription.</p>

    <p>The index creation operation consists of the following jobs:</p>

    <ul>
      <li>Crack, chunk, and embed the text tokens in your brochures data.</li>
      <li>Create the Azure AI Search index.</li>
      <li>Register the index asset.</li>
    </ul>

    <blockquote>
      <p><strong>Tip</strong>: While you’re waiting for the index to be created, why not take a look at the brochures you downloaded to get familiar with their contents?</p>
    </blockquote>
  </li>
</ol>

<h2 id="test-the-index-in-the-playground">Test the index in the playground</h2>

<p>Before using your index in a RAG-based prompt flow, let’s verify that it can be used to affect generative AI responses.</p>

<ol>
  <li>In the navigation pane on the left, select the <strong>Playgrounds</strong> page and open the <strong>Chat</strong> playground.</li>
  <li>On the Chat playground page, in the Setup pane, ensure that your <strong>gpt-4o</strong> model deployment is selected. Then, in the main chat session panel, submit the prompt <code>Where can I stay in New York?</code></li>
  <li>Review the response, which should be a generic answer from the model without any data from the index.</li>
  <li>
    <p>In the Setup pane, expand the <strong>Add your data</strong> field, and then add the <strong>brochures-index</strong> project index and select the <strong>hybrid (vector + keyword)</strong> search type.</p>

    <blockquote>
      <p><strong>Tip</strong>: In some cases, newly created indexes may not be available right away. Refreshing the browser usually helps, but if you’re still experiencing the issue where it can’t find the index you may need to wait until the index is recognized.</p>
    </blockquote>
  </li>
  <li>After the index has been added and the chat session has restarted, resubmit the prompt <code>Where can I stay in New York?</code></li>
  <li>Review the response, which should be based on data in the index.</li>
</ol>

<h2 id="create-a-rag-client-app">Create a RAG client app</h2>

<p>Now that you have a working index, you can use the Azure OpenAI SDK to implement the RAG pattern in a client application. Let’s explore the code to accomplish this in a simple example.</p>

<h3 id="prepare-the-application-configuration">Prepare the application configuration</h3>

<ol>
  <li>Return to the browser tab containing the Azure portal (keeping the Azure AI Foundry portal open in the existing tab).</li>
  <li>
    <p>Use the <strong>[&gt;_]</strong> button to the right of the search bar at the top of the page to create a new Cloud Shell in the Azure portal, selecting a <strong><em>PowerShell</em></strong> environment with no storage in your subscription.</p>

    <p>The cloud shell provides a command-line interface in a pane at the bottom of the Azure portal. You can resize or maximize this pane to make it easier to work in.</p>

    <blockquote>
      <p><strong>Note</strong>: If you have previously created a cloud shell that uses a <em>Bash</em> environment, switch it to <strong><em>PowerShell</em></strong>.</p>
    </blockquote>
  </li>
  <li>
    <p>In the cloud shell toolbar, in the <strong>Settings</strong> menu, select <strong>Go to Classic version</strong> (this is required to use the code editor).</p>

    <p><strong><font color="red">Ensure you've switched to the classic version of the cloud shell before continuing.</font></strong></p>
  </li>
  <li>
    <p>In the cloud shell pane, enter the following commands to clone the GitHub repo containing the code files for this exercise (type the command, or copy it to the clipboard and then right-click in the command line and paste as plain text):</p>

    <pre><code> rm -r mslearn-ai-foundry -f
 git clone https://github.com/microsoftlearning/mslearn-ai-studio mslearn-ai-foundry
</code></pre>

    <blockquote>
      <p><strong>Tip</strong>: As you paste commands into the cloudshell, the output may take up a large amount of the screen buffer. You can clear the screen by entering the <code>cls</code> command to make it easier to focus on each task.</p>
    </blockquote>
  </li>
  <li>
    <p>After the repo has been cloned, navigate to the folder containing the chat application code files:</p>

    <pre><code>cd mslearn-ai-foundry/labfiles/rag-app/python
</code></pre>
  </li>
  <li>
    <p>In the cloud shell command-line pane, enter the following command to install the OpenAI SDK library:</p>

    <pre><code>python -m venv labenv
./labenv/bin/Activate.ps1
pip install -r requirements.txt openai
</code></pre>
  </li>
  <li>
    <p>Enter the following command to edit the configuration file that has been provided:</p>

    <pre><code>code .env
</code></pre>

    <p>The file is opened in a code editor.</p>
  </li>
  <li>In the configuration file, replace the following placeholders:
    <ul>
      <li><strong>your_openai_endpoint</strong>: The Open AI endpoint from your project’s <strong>Overview</strong> page in the Azure AI Foundry portal (be sure to select the <strong>Azure OpenAI</strong> capability tab, not the Azure AI Inference or Azure AI Services capability).</li>
      <li><strong>your_openai_api_key</strong> The Open AI API key from your project’s <strong>Overview</strong> page in the Azure AI Foundry portal (be sure to select the <strong>Azure OpenAI</strong> capability tab, not the Azure AI Inference or Azure AI Services capability).</li>
      <li><strong>your_chat_model</strong>: The name you assigned to your <strong>gpt-4o</strong> model deployment, from the <strong>Models + endpoints</strong> page in the Azure AI Foundry portal (the default name is <code>gpt-4o</code>).</li>
      <li><strong>your_embedding_model</strong>: The name you assigned to your <strong>text-embedding-ada-002</strong> model deployment, from the <strong>Models + endpoints</strong> page in the Azure AI Foundry portal (the default name is <code>text-embedding-ada-002</code>).</li>
      <li><strong>your_search_endpoint</strong>: The URL for your Azure AI Search resource. You’ll find this in the <strong>Management center</strong> in the Azure AI Foundry portal.</li>
      <li><strong>your_search_api_key</strong>: The API key for your Azure AI Search resource. You’ll find this in the <strong>Management center</strong> in the Azure AI Foundry portal.</li>
      <li><strong>your_index</strong>: Replace with your index name from the <strong>Data + indexes</strong> page for your project in the Azure AI Foundry portal (it should be <code>brochures-index</code>).</li>
    </ul>
  </li>
  <li>After you’ve replaced the placeholders, in the code editor, use the <strong>CTRL+S</strong> command or <strong>Right-click &gt; Save</strong> to save your changes and then use the <strong>CTRL+Q</strong> command or <strong>Right-click &gt; Quit</strong> to close the code editor while keeping the cloud shell command line open.</li>
</ol>

<h3 id="explore-code-to-implement-the-rag-pattern">Explore code to implement the RAG pattern</h3>

<ol>
  <li>
    <p>Enter the following command to edit the code file that has been provided:</p>

    <pre><code>code rag-app.py
</code></pre>
  </li>
  <li>Review the code in the file, noting that it:
    <ul>
      <li>Creates an Azure OpenAI client using the endpoint, key, and chat model.</li>
      <li>Creates a suitable system message for a travel-related chat solution.</li>
      <li>Submits a prompt (including the system and a user message based on the user input) to the Azure OpenAI client, adding:
        <ul>
          <li>Connection details for the Azure AI Search index to be queried.</li>
          <li>Details of the embedding model to be used to vectorize the query*.</li>
        </ul>
      </li>
      <li>Displays the response from the grounded prompt.</li>
      <li>Adds the response to the chat history.</li>
    </ul>

    <p>* <em>The query for the search index is based on the prompt, and is used to find relevant text in the indexed documents. You can use a keyword-based search that submits the query as text, but using a vector-based search can be more efficient - hence the use of an embedding model to vectorize the query text before submitting it.</em></p>
  </li>
  <li>Use the <strong>CTRL+Q</strong> command to close the code editor without saving any changes, while keeping the cloud shell command line open.</li>
</ol>

<h3 id="run-the-chat-application">Run the chat application</h3>

<ol>
  <li>
    <p>In the cloud shell command-line pane, enter the following command to run the app:</p>

    <pre><code>python rag-app.py
</code></pre>
  </li>
  <li>
    <p>When prompted, enter a question, such as <code>Where should I go on vacation to see architecture?</code> and review the response from your generative AI model.</p>

    <p>Note that the response includes source references to indicate the indexed data in which the answer was found.</p>
  </li>
  <li>
    <p>Try a follow-up question, for example <code>Where can I stay there?</code></p>
  </li>
  <li>
    <p>When you’re finished, enter <code>quit</code> to exit the program. Then close the cloud shell pane.</p>
  </li>
</ol>

<h2 id="clean-up">Clean up</h2>

<p>To avoid unnecessary Azure costs and resource utilization, you should remove the resources you deployed in this exercise.</p>

<ol>
  <li>If you’ve finished exploring Azure AI Foundry, return to the <a href="https://portal.azure.com">Azure portal</a> at <code>https://portal.azure.com</code> and sign in using your Azure credentials if necessary. Then delete the resources in the resource group where you provisioned your Azure AI Search and Azure AI resources.</li>
</ol>
