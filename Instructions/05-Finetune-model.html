<h1 id="fine-tune-a-language-model">Fine-tune a language model</h1>

<p>When you want a language model to behave a certain way, you can use prompt engineering to define the desired behavior. When you want to improve the consistency of the desired behavior, you can opt to fine-tune a model, comparing it to your prompt engineering approach to evaluate which method best fits your needs.</p>

<p>In this exercise, you’ll fine-tune a language model with the Azure AI Foundry that you want to use for a custom chat application scenario. You’ll compare the fine-tuned model with a base model to assess whether the fine-tuned model fits your needs better.</p>

<p>Imagine you work for a travel agency and you’re developing a chat application to help people plan their vacations. The goal is to create a simple and inspiring chat that suggests destinations and activities with a consistent, friendly conversational tone.</p>

<p>This exercise will take approximately <strong>60</strong> minutes*.</p>

<blockquote>
  <p>* <strong>Note</strong>: This timing is an estimate based on the average experience. Fine-tuning is dependent on cloud infrastructure resources, which can take a variable amount of time to provision depending on data center capacity and concurrent demand. Some activities in this exercise may take a <u>long</u> time to complete, and require patience. If things are taking a while, consider reviewing the <a href="https://learn.microsoft.com/azure/ai-studio/concepts/fine-tuning-overview">Azure AI Foundry fine-tuning documentation</a> or taking a break. It is possible some processes may time-out or appear to run indefinitely. Some of the technologies used in this exercise are in preview or in active development. You may experience some unexpected behavior, warnings, or errors.</p>
</blockquote>

<h2 id="deploy-a-model-in-an-azure-ai-foundry-project">Deploy a model in an Azure AI Foundry project</h2>

<p>Let’s start by deploying a model in an Azure AI Foundry project.</p>

<ol>
  <li>
    <p>In a web browser, open the <a href="https://ai.azure.com">Azure AI Foundry portal</a> at <code>https://ai.azure.com</code> and sign in using your Azure credentials. Close any tips or quick start panes that are opened the first time you sign in, and if necessary use the <strong>Azure AI Foundry</strong> logo at the top left to navigate to the home page, which looks similar to the following image (close the <strong>Help</strong> pane if it’s open):</p>

    <p><img src="./media/ai-foundry-home.png" alt="Screenshot of Azure AI Foundry portal." /></p>
  </li>
  <li>In the home page, in the <strong>Explore models and capabilities</strong> section, search for the <code>gpt-4o</code> model; which we’ll use in our project.</li>
  <li>In the search results, select the <strong>gpt-4o</strong> model to see its details, and then at the top of the page for the model, select <strong>Use this model</strong>.</li>
  <li>When prompted to create a project, enter a valid name for your project and expand <strong>Advanced options</strong>.</li>
  <li>Select <strong>Customize</strong> and specify the following settings for your project:
    <ul>
      <li><strong>Azure AI Foundry resource</strong>: <em>A valid name for your Azure AI Foundry resource</em></li>
      <li><strong>Subscription</strong>: <em>Your Azure subscription</em></li>
      <li><strong>Resource group</strong>: <em>Create or select a resource group</em></li>
      <li><strong>Region</strong>: <em>Select one of the following regions</em>:*
        <ul>
          <li>East US 2</li>
          <li>North Central US</li>
          <li>Sweden Central</li>
        </ul>
      </li>
    </ul>

    <blockquote>
      <p>* At the time of writing, these regions support fine-tuning for gpt-4o models.</p>
    </blockquote>
  </li>
  <li>
    <p>Select <strong>Create</strong> and wait for your project to be created. If prompted, deploy the gpt-4o model using the <strong>Global standard</strong> deployment type and customize the deployment details to set a <strong>Tokens per minute rate limit</strong> of 50K (or the maximum available if less than 50K).</p>

    <blockquote>
      <p><strong>Note</strong>: Reducing the TPM helps avoid over-using the quota available in the subscription you are using. 50,000 TPM should be sufficient for the data used in this exercise. If your available quota is lower than this, you will be able to complete the exercise but you may experience errors if the rate limit is exceeded.</p>
    </blockquote>
  </li>
  <li>When your project is created, the chat playground will be opened automatically so you can test your model:</li>
  <li>In the <strong>Setup</strong> pane, note the name of your model deployment; which should be <strong>gpt-4o</strong>. You can confirm this by viewing the deployment in the <strong>Models and endpoints</strong> page (just open that page in the navigation pane on the left).</li>
  <li>
    <p>In the navigation pane on the left, select <strong>Overview</strong> to see the main page for your project; which looks like this:</p>

    <p><img src="./media/ai-foundry-project.png" alt="Screenshot of a Azure AI Foundry project overview page." /></p>
  </li>
</ol>

<h2 id="fine-tune-a-model">Fine-tune a model</h2>

<p>Because fine-tuning a model takes some time to complete, you’ll start the fine-tuning job now and come back to it after exploring the base gpt-4o model you already deployed.</p>

<ol>
  <li>
    <p>Download the <a href="https://raw.githubusercontent.com/MicrosoftLearning/mslearn-ai-studio/refs/heads/main/data/travel-finetune-hotel.jsonl">training dataset</a> at <code>https://raw.githubusercontent.com/MicrosoftLearning/mslearn-ai-studio/refs/heads/main/data/travel-finetune-hotel.jsonl</code>and save it as a JSONL file locally.</p>

    <blockquote>
      <p><strong>Note</strong>: Your device might default to saving the file as a .txt file. Select all files and remove the .txt suffix to ensure you’re saving the file as JSONL.</p>
    </blockquote>
  </li>
  <li>Navigate to the <strong>Fine-tuning</strong> page under the <strong>Build and customize</strong> section, using the menu on the left.</li>
  <li>Select the button to add a new fine-tune model, select the <strong>gpt-4o</strong> model and then select <strong>Next</strong>.</li>
  <li><strong>Fine-tune</strong> the model using the following configuration:
    <ul>
      <li><strong>Method of customization</strong>: Supervised</li>
      <li><strong>Base model</strong>: <em>Select the default version of <strong>gpt-4o</strong></em></li>
      <li><strong>Training data</strong>: <em>Select the option to <strong>Add training data</strong> and upload and apply the .jsonl file you downloaded previously</em></li>
      <li><strong>Model suffix</strong>: <code>ft-travel</code></li>
      <li><strong>Seed</strong>: *Random</li>
    </ul>
  </li>
  <li>Submit the fine-tuning details, and the job will start. It may take some time to complete. You can continue with the next section of the exercise while you wait.</li>
</ol>

<blockquote>
  <p><strong>Note</strong>: Fine-tuning and deployment can take a significant amount of time (30 minutes or longer), so you may need to check back periodically. You can see more details of the progress so far by selecting the fine-tuning model job and viewing its <strong>Logs</strong> tab.</p>
</blockquote>

<h2 id="chat-with-a-base-model">Chat with a base model</h2>

<p>While you wait for the fine-tuning job to complete, let’s chat with a base GPT 4o model to assess how it performs.</p>

<ol>
  <li>In the navigation pane on the left, select <strong>Playgrounds</strong> and open the <strong>Chat playground</strong>.</li>
  <li>Verify your deployed <strong>gpt-4o</strong> base model is selected in setup pane.</li>
  <li>
    <p>In the chat window, enter the query <code>What can you do?</code> and view the response.</p>

    <p>The answers may be fairly generic. Remember we want to create a chat application that inspires people to travel.</p>
  </li>
  <li>
    <p>Update the system message in the setup pane with the following prompt:</p>

    <pre><code> You are an AI assistant that helps people plan their travel.
</code></pre>
  </li>
  <li>Select <strong>Apply changes</strong> to update the system message.</li>
  <li>
    <p>In the chat window, enter the query <code>What can you do?</code> again, and view the response.
1
 As a response, the assistant may tell you that it can help you book flights, hotels and rental cars for your trip. You want to avoid this behavior.</p>
  </li>
  <li>
    <p>Update the system message again with a new prompt:</p>

    <pre><code> You are an AI travel assistant that helps people plan their trips. Your objective is to offer support for travel-related inquiries, such as visa requirements, weather forecasts, local attractions, and cultural norms.
 You should not provide any hotel, flight, rental car or restaurant recommendations.
 Ask engaging questions to help someone plan their trip and think about what they want to do on their holiday.
</code></pre>
    <p>.</p>
  </li>
  <li>
    <p>Continue testing your chat application to verify it doesn’t provide any information that isn’t grounded in retrieved data. For example, ask the following questions and review the model’s answers, paying particular attention to the tone and writing style that the model uses to respond:</p>

    <p><code>Where in Rome should I stay?</code></p>

    <p><code>I'm mostly there for the food. Where should I stay to be within walking distance of affordable restaurants?</code></p>

    <p><code>What are some local delicacies I should try?</code></p>

    <p><code>When is the best time of year to visit in terms of the weather?</code></p>

    <p><code>What's the best way to get around the city?</code></p>
  </li>
</ol>

<h2 id="review-the-training-file">Review the training file</h2>

<p>The base model seems to work well enough, but you may be looking for a particular conversational style from your generative AI app. The training data used for fine-tuning offers you the chance to create explicit examples of the kinds of response you want.</p>

<ol>
  <li>Open the JSONL file you downloaded previously (you can open it in any text editor)</li>
  <li>
    <p>Examine the list of the JSON documents in the training data file. The first one should be similar to this (formatted for readability):</p>

    <pre><code class="language-json"> {"messages": [
     {"role": "system", "content": "You are an AI travel assistant that helps people plan their trips. Your objective is to offer support for travel-related inquiries, such as visa requirements, weather forecasts, local attractions, and cultural norms. You should not provide any hotel, flight, rental car or restaurant recommendations. Ask engaging questions to help someone plan their trip and think about what they want to do on their holiday."},
     {"role": "user", "content": "What's a must-see in Paris?"},
     {"role": "assistant", "content": "Oh la la! You simply must twirl around the Eiffel Tower and snap a chic selfie! After that, consider visiting the Louvre Museum to see the Mona Lisa and other masterpieces. What type of attractions are you most interested in?"}
     ]}
</code></pre>

    <p>Each example interaction in the list includes the same system message you tested with the base model, a user prompt related to a travel query, and a response. The style of the responses in the training data will help the fine-tuned model learn how it should respond.</p>
  </li>
</ol>

<h2 id="deploy-the-fine-tuned-model">Deploy the fine-tuned model</h2>

<p>When fine-tuning has successfully completed, you can deploy the fine-tuned model.</p>

<ol>
  <li>
    <p>Navigate to the <strong>Fine-tuning</strong> page under <strong>Build and customize</strong> to find your fine-tuning job and its status. If it’s still running, you can opt to continue chatting with your deployed base model or take a break. If it’s completed, you can continue.</p>

    <blockquote>
      <p><strong>Tip</strong>: Use the <strong>Refresh</strong> button in the fine-tuning page to refresh the view. If the fine-tuning job disappears entirely, refresh the page in the browser.</p>
    </blockquote>
  </li>
  <li>Select the fine-tuning job link to open its details page. Then, select the <strong>Metrics</strong> tab and explore the fine-tune metrics.</li>
  <li>Deploy the fine-tuned model with the following configurations:
    <ul>
      <li><strong>Deployment name</strong>: <em>A valid name for your model deployment</em></li>
      <li><strong>Deployment type</strong>: Standard</li>
      <li><strong>Tokens per Minute Rate Limit (thousands)</strong>: 50K <em>(or the maximum available in your subscription if less than 50K)</em></li>
      <li><strong>Content filter</strong>: Default</li>
    </ul>
  </li>
  <li>Wait for the deployment to be complete before you can test it, this might take a while. Check the <strong>Provisioning state</strong> until it has succeeded (you may need to refresh the browser to see the updated status).</li>
</ol>

<h2 id="test-the-fine-tuned-model">Test the fine-tuned model</h2>

<p>Now that you deployed your fine-tuned model, you can test it like you tested your deployed base model.</p>

<ol>
  <li>When the deployment is ready, navigate to the fine-tuned model and select <strong>Open in playground</strong>.</li>
  <li>
    <p>Ensure the system message includes these instructions:</p>

    <pre><code> You are an AI travel assistant that helps people plan their trips. Your objective is to offer support for travel-related inquiries, such as visa requirements, weather forecasts, local attractions, and cultural norms.
 You should not provide any hotel, flight, rental car or restaurant recommendations.
 Ask engaging questions to help someone plan their trip and think about what they want to do on their holiday.
</code></pre>
  </li>
  <li>
    <p>Test your fine-tuned model to assess whether its behavior is more consistent now. For example, ask the following questions again and explore the model’s answers:</p>

    <p><code>Where in Rome should I stay?</code></p>

    <p><code>I'm mostly there for the food. Where should I stay to be within walking distance of affordable restaurants?</code></p>

    <p><code>What are some local delicacies I should try?</code></p>

    <p><code>When is the best time of year to visit in terms of the weather?</code></p>

    <p><code>What's the best way to get around the city?</code></p>
  </li>
  <li>After reviewing the responses, how do they compare to those of the base model?</li>
</ol>

<h2 id="clean-up">Clean up</h2>

<p>If you’ve finished exploring Azure AI Foundry, you should delete the resources you’ve created to avoid unnecessary Azure costs.</p>

<ul>
  <li>Navigate to the <a href="https://portal.azure.com">Azure portal</a> at <code>https://portal.azure.com</code>.</li>
  <li>In the Azure portal, on the <strong>Home</strong> page, select <strong>Resource groups</strong>.</li>
  <li>Select the resource group that you created for this exercise.</li>
  <li>At the top of the <strong>Overview</strong> page for your resource group, select <strong>Delete resource group</strong>.</li>
  <li>Enter the resource group name to confirm you want to delete it, and select <strong>Delete</strong>.</li>
</ul>
